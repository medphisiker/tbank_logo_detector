# Data Preparation — Реализация скриптов

## Scripts in data_preparation/

### Описание скриптов

- **prepare_data_for_colab.py** (в colab_prep/): Создаёт multi-ZIP архивы для загрузки в Colab; упаковывает данные в независимые ZIP для поддиректорий; читает конфигурацию из data_preparation/colab_prep/data_config.json.

- **crop_logos.py** (в synthesis/): Кропит логотипы из официальных референсов по аннотациям COCO; сохраняет кропы в `data_preparation/synthesis/crops/` с именами по классам (purple, white, yellow). Использует функции из пакета `synthesis_generator`.

- **gen_synth.py** (в synthesis/): Генерация синтетических изображений с наложением логотипов (3 класса: purple=0, white=1, yellow=2) на фоны. Поддержка аргумента `--N` для количества изображений (default 20). Augmentations с albumentations (brightness/contrast, noise, blur, HSV). Вывод: `data/data_synt/images/labels/{train/val/test}` в YOLO формате. Использует функции из пакета `synthesis_generator`.

  Пример:
  ```bash
  python gen_synth.py --N 2000
  ```

- **download_backgrounds.py** (в synthesis/): Скачивает фоны с Picsum (random photos, 640x640, 500 шт.); сохраняет в `data_preparation/synthesis/backgrounds/`. Не требует VPN. Использует функции из пакета `synthesis_generator`.

  Пример:
  ```bash
  python download_backgrounds.py
  ```

- **run_synthesis_pipeline.bat** (в корне проекта): Удобный скрипт для запуска всего пайплайна синтеза данных последовательно (crop → download → generate).

  Пример:
  ```cmd
  run_synthesis_pipeline.bat 1000
  ```

### Docker for Synth Gen

#### Описание

- **pyproject.toml**, **Dockerfile**, **docker-build-run.bat/sh**, **run_synth.bat** в `synthesis/`: Создаёт изолированное окружение на базе `python:3.10-slim` с uv для deps (albumentations, pillow, numpy, tqdm, requests). `uv lock && uv sync --frozen`, активирует `.venv`. Копирует `synthesis/` в `/app/synthesis` включая пакет `synthesis_generator`. Mounts: `/app/synthesis` (crops/backgrounds) и `/app/data` (output `data_synt`). CMD: `python gen_synth.py` (поддержка `--N` или env `N`).

#### Структура пакета synthesis_generator

```
synthesis_generator/
├── __init__.py           # Инициализация пакета
├── crop_utils.py         # Функции для обрезки логотипов из COCO
├── background_utils.py   # Функции для скачивания фоновых изображений
├── augmentations.py      # Конфигурация аугментаций Albumentations
└── generator.py          # Основные функции генерации синтетических данных
```

#### Build

- **docker-build-run.bat/sh** (из `data_preparation/synthesis/`): Pull `medphisiker/tbank-synth:latest` и run test с `--N 10`, mounts synthesis/data.

  Пример (sh):
  ```bash
  ./docker-build-run.sh
  ```

- **run_synth.bat** (из корня проекта): Build `tbank-synth` из `synthesis/`, run с mount всего проекта (`/workspace`), env `N` (default 20).

  Пример:
  ```bash
  run_synth.bat 2000
  ```

- Manual build (из `data_preparation/synthesis/`):
  ```bash
  docker build -t tbank-synth -f Dockerfile .
  ```

#### Run

- **Рекомендуемый способ**: Используйте скрипт `run_synthesis_pipeline.bat` из корня проекта:
  ```cmd
  run_synthesis_pipeline.bat 2000
  ```

- Отдельные скрипты (из корня проекта):
  ```cmd
  # Обрезка логотипов
  docker run -v "${PWD}/data_preparation/synthesis:/app/synthesis" -v "${PWD}/data:/app/data" --rm tbank-synth python crop_logos.py

  # Скачивание фонов
  docker run -v "${PWD}/data_preparation/synthesis:/app/synthesis" -v "${PWD}/data:/app/data" --rm tbank-synth python download_backgrounds.py

  # Генерация синтетики
  docker run -v "${PWD}/data_preparation/synthesis:/app/synthesis" -v "${PWD}/data:/app/data" --rm tbank-synth python gen_synth.py --N 2000
  ```

- Альтернатива с env переменной:
  ```cmd
  docker run -v "${PWD}/data_preparation/synthesis:/app/synthesis" -v "${PWD}/data:/app/data" --rm tbank-synth -e N=2000 python gen_synth.py
  ```

- Локальный запуск (без Docker):
  ```bash
  cd data_preparation/synthesis && uv sync && python gen_synth.py --N 2000
  ```

- Note: Все пути автоматически определяются в зависимости от среды (Docker vs локально). Требует Docker Desktop для контейнерного запуска.

#### Publish

```bash
docker login
docker tag tbank-synth medphisiker/tbank-synth:latest
docker push medphisiker/tbank-synth:latest
```

### Использование готового Docker-образа

Для генерации синтетики рекомендуется использовать готовый образ без локальной сборки.

- Pull:
  ```bash
  docker pull medphisiker/tbank-synth:latest
  ```

- Run примеры (аналогично выше, замените `tbank-synth` на `medphisiker/tbank-synth:latest`).

[Готовый образ](https://hub.docker.com/r/medphisiker/tbank-synth).

Примечание: Сгенерированные данные сохраняются в `data/data_synt/`. Поддержка 3 классов логотипов.

### Docker Hub Description

> Docker-образ для генерации синтетических данных логотипов Т-Банка. Включает пакет `synthesis_generator` с модульной архитектурой, `gen_synth.py` с albumentations augmentations, uv для deps (albumentations, pillow, numpy, tqdm, requests). Используйте `docker run` с mounts для `/app/synthesis` и `/app/data`, arg `--N` для количества изображений.
> Пример:
> ```bash
> docker run -v $(pwd)/data_preparation/synthesis:/app/synthesis -v $(pwd)/data:/app/data --rm medphisiker/tbank-synth:latest python gen_synth.py --N 2000
> ```
> Или используйте готовый скрипт:
> ```cmd
> run_synthesis_pipeline.bat 2000
> ```
> Сгенерированные данные сохраняются в `data/data_synt/`. Поддержка 3 классов логотипов с автоматическим определением путей.

Категория: Machine Learning or Data Processing.

[Ссылка на Docker Hub](https://hub.docker.com/r/medphisiker/tbank-synth)

### Разработки

- Скрипты предобработки организованы в `data_preparation/` с поддиректориями: `synthesis/`, `yoloe/`, `colab_prep/`, `label_studio/`.
- Пакет `synthesis_generator` в `data_preparation/synthesis/` содержит модульную архитектуру для генерации синтетических данных.
- Скрипт `run_synthesis_pipeline.bat` в корне проекта для удобного запуска всего пайплайна.
- Независимые ZIP для поддиректорий.
- Автоматическая исправление путей в COCO аннотациях и адаптация к Docker-среде.

### Быстрый старт

Для быстрого запуска всего пайплайна синтеза данных используйте:

```cmd
# Из корня проекта
run_synthesis_pipeline.bat 1000
```

Этот скрипт последовательно выполнит:
1. Обрезку логотипов из официальных изображений
2. Скачивание фоновых изображений
3. Генерацию 1000 синтетических изображений

### Использование пакета synthesis_generator

Пакет можно использовать программно:

```python
from synthesis_generator.crop_utils import crop_logos
from synthesis_generator.background_utils import download_backgrounds
from synthesis_generator.generator import generate_synthetic_dataset

# Обрезка логотипов
crop_logos("data/tbank_official_logos/refs_ls_coco.json",
           "data/tbank_official_logos/images",
           "data_preparation/synthesis/crops")

# Скачивание фонов
download_backgrounds("data_preparation/synthesis/backgrounds", 500, 640)

# Генерация синтетики
generate_synthetic_dataset("data_preparation/synthesis/crops",
                          "data_preparation/synthesis/backgrounds",
                          "data/data_synt", 1000)
```

## Closing notes

* Цель — максимально автоматизировать и документировать происхождение аннотаций (provenance), чтобы при обнаружении проблем можно было быстро проследить, откуда пришло неверное правило и исправить pipeline.
* На верхнем уровне мы используем современную связку VLM + SAM + verification (VLM/ML classifier/OCR) + эмбеддинг-кластеризацию для масштабируемой и дешёвой по времени разметки.
* Следующий шаг: по этому документу сгенерировать runnable notebook / script в `annotation/` с примером запуска Grounding DINO → SAM → ensemble и с шаблоном промптов. Готов приступить и сгенерировать `annotation`-notebook прямо сейчас, если нужно.

Для планов и идей см. [3.data_preparation_plan.md](3.data_preparation_plan.md).
# Data Preparation — Synthesis Scripts

## Обзор

В директории `data_preparation/synthesis/` реализован пайплайн генерации синтетических данных для детекции логотипов Т-Банка. Основан на разработанном нами Python-пакете `synthesis_generator`, который предоставляет модульную архитектуру для создания разнообразных синтетических изображений.

За подробностями о пакете `synthesis_generator` обращайтесь к [`data_preparation/synthesis/synthesis_generator/README.md`](synthesis_generator/README.md).

## Быстрый старт

Для быстрого запуска всего пайплайна синтеза данных используйте BAT или SH скрипты, которые автоматически запускают Docker-контейнер:

```cmd
# Windows (из корня проекта)
run_synthesis_pipeline.bat 1000

# Linux/Mac (из корня проекта)
./run_synthesis_pipeline.sh 1000
```

Эти скрипты последовательно выполнят:
1. Обрезку логотипов из официальных изображений
2. Скачивание фоновых изображений
3. Генерацию 1000 синтетических изображений

Результат сохраняется в `data/data_synt/`.

## Использование готового Docker-образа

Рекомендуется использовать опубликованный Docker-образ без локальной сборки:

```bash
docker pull medphisiker/tbank-synth:latest
```

**Запуск с готовым образом**:
```bash
docker run -v "$(pwd)/data_preparation/synthesis:/app/synthesis" -v "$(pwd)/data:/app/data" --rm medphisiker/tbank-synth:latest python gen_synth.py --N 2000
```

**Через скрипты**:
```cmd
# Windows
run_synthesis_pipeline.bat 2000

# Linux/Mac
./run_synthesis_pipeline.sh 2000
```

### Docker Hub

[Ссылка на Docker Hub](https://hub.docker.com/r/medphisiker/tbank-synth)

**Описание**: Docker-образ для генерации синтетических данных логотипов Т-Банка. Включает пакет `synthesis_generator` с модульной архитектурой, `gen_synth.py` с albumentations augmentations, uv для deps (albumentations, pillow, numpy, tqdm, requests). Используйте `docker run` с mounts для `/app/synthesis` и `/app/data`, arg `--N` для количества изображений.

## Отдельные команды Docker-контейнера

Для запуска отдельных этапов пайплайна используйте прямые команды Docker:

```cmd
# Обрезка логотипов
docker run -v "%CD%/data_preparation/synthesis:/app/synthesis" -v "%CD%/data:/app/data" --rm medphisiker/tbank-synth:latest python crop_logos.py

# Скачивание фонов
docker run -v "%CD%/data_preparation/synthesis:/app/synthesis" -v "%CD%/data:/app/data" --rm medphisiker/tbank-synth:latest python download_backgrounds.py

# Генерация синтетики
docker run -v "%CD%/data_preparation/synthesis:/app/synthesis" -v "%CD%/data:/app/data" --rm medphisiker/tbank-synth:latest python gen_synth.py --N 2000
```

**С переменной окружения**:
```cmd
docker run -v "%CD%/data_preparation/synthesis:/app/synthesis" -v "%CD%/data:/app/data" --rm medphisiker/tbank-synth:latest -e N=2000 python gen_synth.py
```

## Сборка собственного Docker-образа

**Примечание**: Все BAT и SH скрипты в проекте используют готовый образ с DockerHub (`medphisiker/tbank-synth:latest`). Сборка локального образа требуется только для разработки или кастомизации.

Если необходимо собрать образ локально:

### Ручная сборка
```bash
cd data_preparation/synthesis/docker
docker build -t tbank-synth -f Dockerfile .
```

### Через скрипты
```cmd
# Windows
cd data_preparation/synthesis
run_synth.bat 2000

# Linux/Mac
cd data_preparation/synthesis
./docker-build-run.sh
```

### Структура образа

- **Базовый образ**: `python:3.10-slim`
- **Рабочая директория**: `/app`
- **Mount точки**:
  - `/app/synthesis`: директория с кодом и промежуточными данными
  - `/app/data`: директория с входными и выходными данными
- **CMD**: `python gen_synth.py`
- **Поддержка**: аргументы `--N` и переменная окружения `N`

### Публикация образа
```bash
docker login
docker tag tbank-synth medphisiker/tbank-synth:latest
docker push medphisiker/tbank-synth:latest
```

## Batch-скрипты (Windows)

### run_synthesis_pipeline.bat

**Расположение**: Корень проекта (`run_synthesis_pipeline.bat`)

**Назначение**: Основной скрипт для запуска всего пайплайна (использует Docker-контейнер).

**Функциональность**:
- Принимает параметр `N` для количества изображений (default: 20)
- Последовательно выполняет все этапы в Docker-контейнере
- Выводит статус выполнения каждого шага

**Запуск**:
```cmd
run_synthesis_pipeline.bat 1000
```

### run_synth.bat

**Расположение**: `data_preparation/synthesis/run_synth.bat`

**Назначение**: Сборка и запуск Docker-контейнера.

**Функциональность**:
- Собирает образ `tbank-synth` локально
- Монтирует проект и запускает генерацию

**Запуск**:
```cmd
cd data_preparation/synthesis
run_synth.bat 2000
```

### docker-build-run.bat

**Расположение**: `data_preparation/synthesis/docker-build-run.bat`

**Назначение**: Тестовый запуск с готовым образом.

**Функциональность**:
- Скачивает готовый образ
- Запускает тестовую генерацию с `N=10`

**Запуск**:
```cmd
cd data_preparation/synthesis
docker-build-run.bat
```

## Shell-скрипты (Linux/Mac)

### run_synthesis_pipeline.sh

**Расположение**: Корень проекта (`run_synthesis_pipeline.sh`)

**Назначение**: Аналог `run_synthesis_pipeline.bat` для Unix-систем (использует Docker-контейнер).

**Функциональность**:
- Аналогична Windows-версии
- Поддержка переменной `N_VAL` (default: 20)

**Запуск**:
```bash
./run_synthesis_pipeline.sh 1000
```

### docker-build-run.sh

**Расположение**: `data_preparation/synthesis/docker-build-run.sh`

**Назначение**: Аналог `docker-build-run.bat` для Unix-систем.

**Функциональность**:
- Скачивает готовый образ
- Тестовая генерация с `N=10`

**Запуск**:
```bash
cd data_preparation/synthesis
./docker-build-run.sh
```

## Python-скрипты

### crop_logos.py

**Назначение**: Обрезка логотипов из официальных референсных изображений по аннотациям COCO.

**Функциональность**:
- Загружает COCO-аннотации из `data/tbank_official_logos/refs_ls_coco.json`
- Обрабатывает изображения из `data/tbank_official_logos/images/`
- Сохраняет обрезанные логотипы в `data_preparation/synthesis/crops/` с именами по классам (purple_XX.png, white_XX.png, yellow_XX.png)
- Использует функции из пакета `synthesis_generator.crop_utils`

**Запуск**:
```bash
cd data_preparation/synthesis
python crop_logos.py
```

**Особенности**:
- Автоматически определяет пути в зависимости от среды (Docker vs локально)
- В Docker использует `/app/data/`, локально - относительные пути от корня проекта

### download_backgrounds.py

**Назначение**: Скачивание фоновых изображений для синтеза.

**Функциональность**:
- Скачивает случайные фотографии с сервиса Picsum (https://picsum.photos)
- Размер изображений: 640x640 пикселей (по умолчанию)
- Количество: 10 изображений (по умолчанию, можно изменить в коде)
- Сохраняет в `data_preparation/synthesis/backgrounds/bg_XXXX.jpg`
- Использует функции из пакета `synthesis_generator.background_utils`

**Запуск**:
```bash
cd data_preparation/synthesis
python download_backgrounds.py
```

**Особенности**:
- Не требует VPN или API-ключей
- Показывает прогресс загрузки с помощью tqdm
- Обрабатывает ошибки сети и продолжает загрузку

### gen_synth.py

**Назначение**: Основной скрипт генерации синтетических данных.

**Функциональность**:
- Принимает аргумент `--N` для количества генерируемых изображений (default: 20)
- Поддерживает переменную окружения `N`
- Использует обрезанные логотипы из `crops/` и фоны из `backgrounds/`
- Применяет аугментации из `synthesis_generator.augmentations`
- Генерирует изображения и лейблы в формате YOLO
- Автоматически распределяет по сплитам train/val/test

**Запуск**:
```bash
cd data_preparation/synthesis
python gen_synth.py --N 2000
```

**Аргументы**:
- `--N`: количество синтетических изображений (int, default: 20)

**Особенности**:
- Автоматическое определение путей (Docker: `/app/data/`, локально: `../../data/`)
- Логирование процесса генерации
- Проверка наличия необходимых файлов перед запуском


## Closing notes

* Цель — максимально автоматизировать и документировать происхождение аннотаций (provenance), чтобы при обнаружении проблем можно было быстро проследить, откуда пришло неверное правило и исправить pipeline.
* На верхнем уровне мы используем современную связку VLM + SAM + verification (VLM/ML classifier/OCR) + эмбеддинг-кластеризацию для масштабируемой и дешёвой по времени разметки.
* Следующий шаг: по этому документу сгенерировать runnable notebook / script в `annotation/` с примером запуска Grounding DINO → SAM → ensemble и с шаблоном промптов. Готов приступить и сгенерировать `annotation`-notebook прямо сейчас, если нужно.

Для планов и идей см. [3.data_preparation_plan.md](3.data_preparation_plan.md).
# Data Preparation — Реализация скриптов

## Scripts in data_preparation/

### Описание скриптов

- **prepare_data_for_colab.py** (в colab_prep/): Создаёт multi-ZIP архивы для загрузки в Colab; упаковывает данные в независимые ZIP для поддиректорий.

- **crop_logos.py** (в synthesis/): Кропит логотипы из официальных референсов по аннотациям COCO; сохраняет кропы в `data_preparation/synthesis/crops/` с именами по классам (purple, white, yellow).

- **gen_synth.py** (в synthesis/): Генерация синтетических изображений с наложением логотипов (3 класса: purple=0, white=1, yellow=2) на фоны. Поддержка аргумента `--N` для количества изображений (default 20). Augmentations с albumentations (brightness/contrast, noise, blur, HSV). Вывод: `data/data_synt/images/labels/{train/val/test}` в YOLO формате.

  Пример:
  ```bash
  python gen_synth.py --N 2000
  ```

- **download_backgrounds.py** (в synthesis/): Скачивает фоны с Picsum (random photos, 640x640, 500 шт.); сохраняет в `data_preparation/synthesis/backgrounds/`. Не требует VPN.

  Пример:
  ```bash
  python download_backgrounds.py
  ```

### Docker for Synth Gen

#### Описание

- **pyproject.toml**, **Dockerfile**, **docker-build-run.bat/sh**, **run_synth.bat** в `synthesis/`: Создаёт изолированное окружение на базе `python:3.10-slim` с uv для deps (albumentations, pillow, numpy). `uv lock && uv sync --frozen`, активирует `.venv`. Копирует `synthesis/` в `/app/synthesis`. Mounts: `/app/synthesis` (crops/backgrounds) и `/app/data` (output `data_synt`). CMD: `python gen_synth.py` (поддержка `--N` или env `N`).

#### Build

- **docker-build-run.bat/sh** (из `data_preparation/synthesis/`): Pull `medphisiker/tbank-synth:latest` и run test с `--N 10`, mounts synthesis/data.

  Пример (sh):
  ```bash
  ./docker-build-run.sh
  ```

- **run_synth.bat** (из корня проекта): Build `tbank-synth` из `synthesis/`, run с mount всего проекта (`/workspace`), env `N` (default 20).

  Пример:
  ```bash
  run_synth.bat 2000
  ```

- Manual build (из `data_preparation/synthesis/`):
  ```bash
  docker build -t tbank-synth -f Dockerfile .
  ```

#### Run

- С mount (из корня проекта, cross-platform с `$(pwd)`; для Windows cmd используйте `%CD%`):
  ```bash
  docker run -v $(pwd)/data_preparation/synthesis:/app/synthesis -v $(pwd)/data:/app/data --rm medphisiker/tbank-synth:latest python gen_synth.py --N 2000
  ```
  Альтернатива env:
  ```bash
  docker run -v $(pwd)/data_preparation/synthesis:/app/synthesis -v $(pwd)/data:/app/data --rm medphisiker/tbank-synth:latest -e N=2000
  ```

  Для Windows (cmd):
  ```cmd
  docker run -v "%CD%/data_preparation/synthesis:/app/synthesis" -v "%CD%/data:/app/data" --rm medphisiker/tbank-synth:latest python gen_synth.py --N 2000
  ```

  Для Windows (PowerShell):
  ```powershell
  docker run -v "${PWD}/data_preparation/synthesis:/app/synthesis" -v "${PWD}/data:/app/data" --rm medphisiker/tbank-synth:latest python gen_synth.py --N 2000
  ```

- Note: Требует Docker Desktop. gen_synth.py использует albumentations для augmentations. Local run:
  ```bash
  cd data_preparation/synthesis && uv sync && python gen_synth.py --N 2000
  ```

#### Publish

```bash
docker login
docker tag tbank-synth medphisiker/tbank-synth:latest
docker push medphisiker/tbank-synth:latest
```

### Использование готового Docker-образа

Для генерации синтетики рекомендуется использовать готовый образ без локальной сборки.

- Pull:
  ```bash
  docker pull medphisiker/tbank-synth:latest
  ```

- Run примеры (аналогично выше, замените `tbank-synth` на `medphisiker/tbank-synth:latest`).

[Готовый образ](https://hub.docker.com/r/medphisiker/tbank-synth).

Примечание: Сгенерированные данные сохраняются в `data/data_synt/`. Поддержка 3 классов логотипов.

### Docker Hub Description

> Docker-образ для генерации синтетических данных логотипов Т-Банка. Включает `gen_synth.py` с albumentations augmentations, uv для deps (albumentations, pillow, numpy). Используйте `docker run` с mounts для `/app/synthesis` и `/app/data`, arg `--N` для количества изображений.
> Пример:
> ```bash
> docker run -v $(pwd)/data_preparation/synthesis:/app/synthesis -v $(pwd)/data:/app/data --rm medphisiker/tbank-synth:latest python gen_synth.py --N 2000
> ```
> Сгенерированные данные сохраняются в `data/data_synt/`. Поддержка 3 классов логотипов.

Категория: Machine Learning or Data Processing.

[Ссылка на Docker Hub](https://hub.docker.com/r/medphisiker/tbank-synth)

### Разработки

- Скрипты предобработки организованы в `data_preparation/` с поддиректориями: `synthesis/`, `yoloe/`, `colab_prep/`, `label_studio/`.
- Независимые ZIP для поддиректорий.
- Автоматическая исправление путей в COCO аннотациях.

## Closing notes

* Цель — максимально автоматизировать и документировать происхождение аннотаций (provenance), чтобы при обнаружении проблем можно было быстро проследить, откуда пришло неверное правило и исправить pipeline.
* На верхнем уровне мы используем современную связку VLM + SAM + verification (VLM/ML classifier/OCR) + эмбеддинг-кластеризацию для масштабируемой и дешёвой по времени разметки.
* Следующий шаг: по этому документу сгенерировать runnable notebook / script в `annotation/` с примером запуска Grounding DINO → SAM → ensemble и с шаблоном промптов. Готов приступить и сгенерировать `annotation`-notebook прямо сейчас, если нужно.

Для планов и идей см. [3.data_preparation_plan.md](3.data_preparation_plan.md).